rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the user is an admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // 1. User Profile Document
    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId || 
        isAdmin() || 
        resource.data.email == request.auth.token.email ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.linkedAccountId == userId
      );
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // 2. User Daily Logs Subcollection
    match /users/{userId}/daily_logs/{logId} {
       allow read: if request.auth != null && (
         request.auth.uid == userId || 
         isAdmin() || 
         get(/databases/$(database)/documents/users/$(userId)).data.email == request.auth.token.email ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.linkedAccountId == userId
       );
       allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }
    
    // 3. Fallback for other subcollections (if any)
    // match /users/{userId}/{document=**} { ... } 
    // Removed to prevent shadowing/conflicts. If we add more subcollections, valid rules must be added.
  }
}
